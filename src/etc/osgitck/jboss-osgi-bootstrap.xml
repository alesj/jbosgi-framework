<deployment xmlns="urn:jboss:bean-deployer:2.0">

  <!-- 
  ********************************
  *                              *  
  *  OSGi Framework              *
  *                              *
  ********************************
  -->
  
  <bean name="OSGiBundleManager" class="org.jboss.osgi.framework.bundle.OSGiBundleManager">
    <constructor>
      <parameter><inject bean="jboss.kernel:service=Kernel" /></parameter>
      <parameter><inject bean="MainDeployer" /></parameter>
    </constructor>
    <property name="properties">
      <map keyClass="java.lang.String" valueClass="java.lang.String">
        <entry><key>org.osgi.framework.storage</key><value>./generated/osgi-store</value></entry>
        <entry><key>org.osgi.framework.storage.clean</key><value>onFirstInit</value></entry>
        <entry><key>org.osgi.framework.system.packages.extra</key><value>
        
          <!-- logging -->
          org.apache.log4j;version=1.2,
          org.jboss.logging;version=2.1,
          
          <!-- jboss -->
          org.jboss.beans.metadata.plugins;version=2.2,
          org.jboss.beans.metadata.plugins.builder;version=2.2,
          org.jboss.beans.metadata.spi;version=2.2,
          org.jboss.beans.metadata.spi.builder;version=2.2,
          org.jboss.dependency.spi;version=2.2,
          org.jboss.kernel.spi.dependency;version=2.2,
          
          <!-- jboss-osgi -->
          org.jboss.osgi.spi;version=1.0,
          org.jboss.osgi.spi.capability;version=1.0,
          org.jboss.osgi.spi.framework;version=1.0,
          org.jboss.osgi.spi.management;version=1.0,
          org.jboss.osgi.spi.service;version=1.0,
          org.jboss.osgi.spi.util;version=1.0,
          org.jboss.osgi.testing;version=1.0
        </value></entry>
      </map>
    </property>
    <incallback method="addPlugin" />
    <uncallback method="removePlugin" />
  </bean>
  
  <!-- 
  ********************************
  *                              *  
  *  OSGi Framework Plugins      *
  *                              *
  ********************************
  -->
  
  <bean name="OSGiControllerContextPlugin" class="org.jboss.osgi.framework.bundle.ControllerContextPluginImpl">
    <constructor>
      <parameter><inject bean="OSGiBundleManager" /></parameter>
      <parameter><inject bean="OSGiDeploymentRegistry" /></parameter>
    </constructor>
  </bean>
  <bean name="OSGiFrameworkEventsPlugin" class="org.jboss.osgi.framework.plugins.internal.FrameworkEventsPluginImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  <bean name="OSGiServiceManagerPlugin" class="org.jboss.osgi.framework.bundle.ServiceManagerPluginImpl">
    <constructor>
      <parameter><inject bean="OSGiBundleManager" /></parameter>
      <parameter><inject bean="OSGiDeploymentRegistry" /></parameter>
    </constructor>
  </bean>
  <bean name="OSGiStoragePlugin" class="org.jboss.osgi.framework.plugins.internal.BundleStoragePluginImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  <bean name="OSGiSystemPackages" class="org.jboss.osgi.framework.plugins.internal.SystemPackagesPluginImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  
  <!-- 
  ********************************
  *                              *  
  *  OSGi Service Plugins        *
  *                              *
  ********************************
  -->
  
  <bean name="MicrocontainerService" class="org.jboss.osgi.framework.service.internal.MicrocontainerServiceImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  <bean name="StartLevelService" class="org.jboss.osgi.framework.service.internal.StartLevelImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  <bean name="PackageAdminService" class="org.jboss.osgi.framework.service.internal.PackageAdminImpl">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  
  <!--
  ********************************
  *                              *  
  *  OSGi Deployment             *
  *                              *
  ********************************
  -->
  
  <!-- The MainDeployer -->
  <bean name="MainDeployer" class="org.jboss.deployers.plugins.main.MainDeployerImpl">
    <property name="structuralDeployers"><inject bean="StructuralDeployers" /></property>
    <property name="deployers"><inject bean="Deployers" /></property>
  </bean>

  <!-- The holder for deployers that determine structure -->
  <bean name="StructuralDeployers" class="org.jboss.deployers.vfs.plugins.structure.VFSStructuralDeployersImpl">
    <property name="structureBuilder">
      <!-- The consolidator of the structure information -->
      <bean name="StructureBuilder" class="org.jboss.deployers.vfs.plugins.structure.VFSStructureBuilder" />
    </property>
    <!-- Accept any implementor of structure deployer -->
    <incallback method="addDeployer" />
    <uncallback method="removeDeployer" />
  </bean>

  <!-- The holder for deployers that do real deployment -->
  <bean name="Deployers" class="org.jboss.deployers.plugins.deployers.DeployersImpl">
    <constructor><parameter><inject bean="jboss.kernel:service=KernelController" /></parameter></constructor>
    <!-- Accept any implementor of deployer -->
    <incallback method="addDeployer" />
    <uncallback method="removeDeployer" />
  </bean>

  <!-- Bundle Structure -->
  <bean name="BundleStructure" class="org.jboss.osgi.deployer.BundleStructureDeployer" />
  
  <!-- JAR & File Structure (needed for negative testing) -->
  <bean name="JARStructure" class="org.jboss.deployers.vfs.plugins.structure.jar.JARStructure" />
  <bean name="FileStructure" class="org.jboss.deployers.vfs.plugins.structure.file.FileStructure" />

  <!-- POJO Deployment -->
  <bean name="BeanDeployer" class="org.jboss.deployers.vfs.deployer.kernel.BeanDeployer" />
  <bean name="KernelDeploymentDeployer" class="org.jboss.deployers.vfs.deployer.kernel.KernelDeploymentDeployer" />
  <bean name="BeanMetaDataDeployer" class="org.jboss.deployers.vfs.deployer.kernel.BeanMetaDataDeployer">
    <constructor>
      <parameter class="org.jboss.dependency.spi.Controller"><inject bean="jboss.kernel:service=KernelController" /></parameter>
    </constructor>
    <property name="deploymentRegistry"><inject bean="OSGiDeploymentRegistry"/></property>
  </bean>

  <!-- The deployment registry -->
  <bean name="OSGiDeploymentRegistry" class="org.jboss.deployers.structure.spi.helpers.AbstractDeploymentRegistry"/>

  <!-- OSGI Deployment -->
  <bean name="OSGiBundleActivatorDeployer" class="org.jboss.osgi.framework.deployers.OSGiBundleActivatorDeployer" />
  <bean name="OSGiBundleStateAddDeployer" class="org.jboss.osgi.framework.deployers.OSGiBundleStateAddDeployer">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  <bean name="OSGiBundleStateRemoveDeployer" class="org.jboss.osgi.framework.deployers.OSGiBundleStateRemoveDeployer">
    <constructor><parameter><inject bean="OSGiBundleManager" /></parameter></constructor>
  </bean>
  <bean name="OSGiContextTrackerDeployer" class="org.jboss.osgi.framework.deployers.OSGiContextTrackerDeployer" />
  <bean name="OSGiManifestParsingDeployer" class="org.jboss.osgi.framework.deployers.OSGiManifestParsingDeployer" />
  <bean name="OSGiNativeCodeMetaDataDeployer" class="org.jboss.osgi.framework.deployers.OSGiNativeCodeMetaDataDeployer" />

  <!--
  ********************************
  *                              *  
  *  OSGi Classloading           *
  *                              *
  ********************************
  -->
  
  <bean name="OSGiClassLoaderSystem" class="org.jboss.osgi.framework.classloading.OSGiClassLoaderSystem" />
  <bean name="OSGiClassLoaderDomain" class="org.jboss.osgi.framework.classloading.OSGiClassLoaderDomain" >
    <constructor><parameter>OSGiClassLoaderDomain</parameter></constructor>
    <property name="classLoaderSystem"><inject bean="OSGiClassLoaderSystem"/></property>
    <property name="bundleManager"><inject bean="OSGiBundleManager" /></property>
  </bean>
  <bean name="OSGiClassLoaderFactory" class="org.jboss.osgi.framework.classloading.OSGiClassLoaderFactory" >
    <property name="system"><inject bean="OSGiClassLoaderSystem"/></property>
  </bean>
  <bean name="OSGiClassLoadingDeployer" class="org.jboss.osgi.framework.deployers.OSGiBundleClassLoadingDeployer">
    <property name="domain"><inject bean="OSGiClassLoaderDomain"/></property>
    <property name="factory"><inject bean="OSGiClassLoaderFactory"/></property>
  </bean>
  <bean name="OSGiFragmentClassLoadingDeployer" class="org.jboss.osgi.framework.deployers.OSGiFragmentClassLoadingDeployer">
    <property name="domain"><inject bean="OSGiClassLoaderDomain"/></property>
    <property name="factory"><inject bean="OSGiClassLoaderFactory"/></property>
  </bean>
  <bean name="OSGiModuleDeployer" class="org.jboss.osgi.framework.deployers.OSGiModuleDeployer">
    <property name="classLoading"><inject bean="ClassLoading" /></property>
  </bean>
  <bean name="OSGiFragmentAttachmentDeployer" class="org.jboss.osgi.framework.deployers.OSGiFragmentAttachmentDeployer"/>
   
  <bean name="ClassLoading" class="org.jboss.classloading.spi.dependency.ClassLoading">
    <incallback method="addModule" state="Configured" />
    <uncallback method="removeModule" state="Configured" />
  </bean>
  <bean name="ClassLoadingDefaultDeployer" class="org.jboss.deployers.plugins.classloading.ClassLoadingDefaultDeployer">
    <property name="defaultMetaData">
      <classloading xmlns="urn:jboss:classloading:1.0" export-all="NON_EMPTY" import-all="true" />
    </property>
  </bean>
  <bean name="ClassLoaderClassPathDeployer" class="org.jboss.deployers.vfs.plugins.classloader.VFSClassLoaderClassPathDeployer" />
  <bean name="ClassLoaderDeployer" class="org.jboss.deployers.plugins.classloading.AbstractLevelClassLoaderSystemDeployer">
    <property name="classLoading"><inject bean="ClassLoading" /></property>
    <property name="system"><inject bean="OSGiClassLoaderSystem" /></property>
  </bean>

</deployment>
